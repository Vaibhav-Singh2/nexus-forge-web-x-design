generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    password      String?
    role          String    @default("STUDENT") // "STUDENT", "ADMIN"
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    sessions ExamSession[]
    accounts Account[]
}

model Journey {
    id               String  @id @default(cuid())
    title            String
    description      String
    difficulty       String
    duration         String
    totalQuestions   Int
    prerequisiteId   String?
    minScoreToUnlock Int     @default(0)

    questions    Question[]
    sessions     ExamSession[]
    prerequisite Journey?      @relation("JourneyPrerequisite", fields: [prerequisiteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    nextJourneys Journey[]     @relation("JourneyPrerequisite")
}

model Question {
    id            String  @id @default(cuid())
    journeyId     String
    text          String
    options       String // Stored as JSON string
    correctOption String
    explanation   String?

    journey Journey @relation(fields: [journeyId], references: [id])
}

model ExamSession {
    id          String    @id @default(cuid())
    userId      String
    journeyId   String
    status      String    @default("IN_PROGRESS") // "IN_PROGRESS", "COMPLETED", "ABANDONED", "DISTRESS"
    currentStep Int       @default(0)
    score       Int       @default(0)
    totalPoints Int       @default(0)
    startTime   DateTime  @default(now())
    endTime     DateTime?

    user    User         @relation(fields: [userId], references: [id])
    journey Journey      @relation(fields: [journeyId], references: [id])
    logs    JourneyLog[]
}

model JourneyLog {
    id           String   @id @default(cuid())
    sessionId    String
    stepIndex    Int
    action       String // "START", "ANSWER_QUESTION", "ENTER_OVERLOOK", "RESUME_ASCENT", "SUMMIT_REACHED"
    timestamp    DateTime @default(now())
    metadata     String? // Stored as JSON string
    isCorrect    Boolean?
    pointsEarned Int      @default(0)

    session ExamSession @relation(fields: [sessionId], references: [id])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}
